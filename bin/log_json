#!/usr/bin/env bash

# Check if jq is installed
if ! command -v jq >/dev/null 2>&1; then
  echo "Error: jq is required but not installed" >&2
  exit 1
fi

log_json() {
  if [ $# -lt 2 ]; then
    echo "Error: Both level and message are required" >&2
    echo "Usage: log_json LEVEL MESSAGE" >&2
    return 1
  fi
  
  local level="$1"
  local message="$2"

  echo "$(jq -nc \
    --arg level "$level" \
    --arg message "$message" \
    --arg time "$(date +"%Y-%m-%dT%H:%M:%S.%3N%z" | sed 's/\(..\)\(..\)$/\1:\2/')" \
    '{timestamp: $time, level: $level, message: $message}')"
}

if [[ "$1" == "--version" ]]; then
  SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &> /dev/null && pwd)"
  if [ -f "$SCRIPT_DIR/version" ]; then
    VERSION=$(cat "$SCRIPT_DIR/version")
  else
    VERSION="unknown"
  fi
  echo "log_json version v$VERSION"
  exit 0
fi

log_json "$@" || exit 1
